<div class="pricing-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="bi bi-tag-fill"></i>
        {{ 'pricing.management' | translate }}
      </h1>
      <p>{{ 'pricing.manageAcross' | translate }}</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" (click)="exportPlans()">
        <i class="bi bi-download"></i>
        {{ 'common.export' | translate }}
      </button>
      <button class="btn btn-primary" (click)="openAddModal()">
        <i class="bi bi-plus-circle"></i>
        {{ 'pricing.addNew' | translate }}
      </button>
    </div>
  </div>

  <!-- Enhanced Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card website-card" (click)="filterByServiceType('website')">
      <div class="stat-icon">
        <i class="bi bi-globe2"></i>
      </div>
      <div class="stat-info">
        <h3>{{ getPlanCountByCategory('website') }}</h3>
        <p>{{ 'pricing.websitePlans' | translate }}</p>
        <div class="stat-meta">
          <span class="active-count">{{ getActivePlansByCategory('website') }} {{ 'pricing.active' | translate }}</span>
        </div>
      </div>
      <div class="stat-arrow">
        <i class="bi bi-arrow-right"></i>
      </div>
    </div>

    <div class="stat-card app-card" (click)="filterByServiceType('app')">
      <div class="stat-icon">
        <i class="bi bi-phone"></i>
      </div>
      <div class="stat-info">
        <h3>{{ getPlanCountByCategory('app') }}</h3>
        <p>{{ 'pricing.appPlans' | translate }}</p>
        <div class="stat-meta">
          <span class="active-count">{{ getActivePlansByCategory('app') }} {{ 'pricing.active' | translate }}</span>
        </div>
      </div>
      <div class="stat-arrow">
        <i class="bi bi-arrow-right"></i>
      </div>
    </div>

    <div class="stat-card package-card" (click)="filterByServiceType('both')">
      <div class="stat-icon">
        <i class="bi bi-rocket-takeoff"></i>
      </div>
      <div class="stat-info">
        <h3>{{ getPlanCountByCategory('both') }}</h3>
        <p>{{ 'pricing.packagePlans' | translate }}</p>
        <div class="stat-meta">
          <span class="active-count">{{ getActivePlansByCategory('both') }} {{ 'pricing.active' | translate }}</span>
        </div>
      </div>
      <div class="stat-arrow">
        <i class="bi bi-arrow-right"></i>
      </div>
    </div>

    <div class="stat-card total-card">
      <div class="stat-icon">
        <i class="bi bi-collection"></i>
      </div>
      <div class="stat-info">
        <h3>{{ plans.length }}</h3>
        <p>{{ 'pricing.totalPlans' | translate }}</p>
        <div class="stat-meta">
          <span class="popular-count">{{ getPopularPlansCount() }} {{ 'pricing.popular' | translate }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions Bar -->
  <div class="quick-actions-bar" *ngIf="filteredPlans.length > 0">
    <div class="actions-left">
      <span class="results-count">
        <i class="bi bi-funnel"></i>
        {{ 'pricing.showing' | translate }} {{ filteredPlans.length }} {{ 'pricing.of' | translate }} {{ plans.length }} {{ 'pricing.plans' | translate }}
      </span>
    </div>
    <div class="actions-right">
      <button class="btn-quick" (click)="activateAll()" [title]="'pricing.activateAll' | translate">
        <i class="bi bi-check-circle"></i>
        {{ 'pricing.activateAll' | translate }}
      </button>
      <button class="btn-quick" (click)="deactivateAll()" [title]="'pricing.deactivateAll' | translate">
        <i class="bi bi-x-circle"></i>
        {{ 'pricing.deactivateAll' | translate }}
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <label><i class="bi bi-translate"></i> {{ 'common.language' | translate }}:</label>
      <div class="filter-buttons">
        <button 
          class="filter-btn" 
          [class.active]="selectedLanguage === 'all'"
          (click)="filterByLanguage('all')">
          <span class="badge">{{ plans.length }}</span>
          {{ 'common.all' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedLanguage === 'en'"
          (click)="filterByLanguage('en')">
          <span class="badge">{{ getPlansByLanguage('en') }}</span>
          {{ 'common.english' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedLanguage === 'ar'"
          (click)="filterByLanguage('ar')">
          <span class="badge">{{ getPlansByLanguage('ar') }}</span>
          {{ 'common.arabic' | translate }}
        </button>
      </div>
    </div>

    <div class="filter-group">
      <label><i class="bi bi-grid-3x3"></i> {{ 'pricing.serviceType' | translate }}:</label>
      <div class="filter-buttons">
        <button 
          class="filter-btn" 
          [class.active]="selectedServiceType === 'all'"
          (click)="filterByServiceType('all')">
          {{ 'common.all' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedServiceType === 'website'"
          (click)="filterByServiceType('website')">
          üåê {{ 'pricing.website' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedServiceType === 'app'"
          (click)="filterByServiceType('app')">
          üì± {{ 'pricing.app' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedServiceType === 'both'"
          (click)="filterByServiceType('both')">
          üöÄ {{ 'pricing.package' | translate }}
        </button>
      </div>
    </div>

    <div class="filter-group">
      <label><i class="bi bi-layers"></i> {{ 'pricing.tier' | translate }}:</label>
      <div class="filter-buttons">
        <button 
          class="filter-btn" 
          [class.active]="selectedTier === 'all'"
          (click)="filterByTier('all')">
          {{ 'common.all' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedTier === 'basic'"
          (click)="filterByTier('basic')">
          {{ 'pricing.basic' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedTier === 'professional'"
          (click)="filterByTier('professional')">
          {{ 'pricing.professional' | translate }}
        </button>
        <button 
          class="filter-btn" 
          [class.active]="selectedTier === 'enterprise'"
          (click)="filterByTier('enterprise')">
          {{ 'pricing.enterprise' | translate }}
        </button>
      </div>
    </div>

    <div class="search-box">
      <i class="bi bi-search"></i>
      <input 
        type="text" 
        [placeholder]="'pricing.searchPlaceholder' | translate" 
        [(ngModel)]="searchTerm"
        (input)="onSearch()">
      <button class="clear-search" *ngIf="searchTerm" (click)="clearSearch()">
        <i class="bi bi-x"></i>
      </button>
    </div>

    <button class="btn btn-secondary" (click)="refreshData()">
      <i class="bi bi-arrow-clockwise"></i>
      {{ 'common.refresh' | translate }}
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>{{ 'common.loading' | translate }}</p>
  </div>

  <!-- Plans Grid -->
  <div class="plans-grid" *ngIf="!loading && filteredPlans.length > 0">
    <div class="plan-card" *ngFor="let plan of filteredPlans" [class.inactive]="!plan.is_active">
      <!-- Popular Badge -->
      <div class="popular-badge" *ngIf="plan.is_popular">
        <i class="bi bi-star-fill"></i>
        {{ 'pricing.popular' | translate }}
      </div>

      <!-- Status Badge -->
      <div class="status-badge" [class.active]="plan.is_active">
        {{ plan.is_active ? ('pricing.active' | translate) : ('pricing.inactive' | translate) }}
      </div>

      <!-- Card Header -->
      <div class="card-header">
        <div class="service-type-badge" [class]="plan.service_type">
          <span *ngIf="plan.service_type === 'website'">üåê</span>
          <span *ngIf="plan.service_type === 'app'">üì±</span>
          <span *ngIf="plan.service_type === 'both'">üöÄ</span>
          {{ getServiceCategoryName(plan.service_type) }}
        </div>
        <div class="tier-badge" [class]="plan.tier">
          <i class="bi bi-award"></i>
          {{ getTierName(plan.tier) }}
        </div>
      </div>

      <!-- Plan Info -->
      <div class="plan-info">
        <h3>{{ plan.name }}</h3>
        <p>{{ plan.description }}</p>
        <div class="meta-info">
          <div class="language-badge">
            <i class="bi bi-translate"></i>
            {{ plan.language === 'en' ? ('common.english' | translate) : ('common.arabic' | translate) }}
          </div>
          <div class="order-badge">
            <i class="bi bi-sort-numeric-down"></i>
            {{ 'pricing.order' | translate }}: {{ plan.order }}
          </div>
        </div>
      </div>

      <!-- Enhanced Pricing -->
      <div class="pricing-info">
        <div class="price-comparison">
          <div class="price-item monthly">
            <span class="label">
              <i class="bi bi-calendar-month"></i>
              {{ 'pricing.monthly' | translate }}
            </span>
            <span class="price">${{ plan.price_monthly }}</span>
            <span class="period">{{ 'pricing.perMonth' | translate }}</span>
          </div>
          <div class="price-item yearly">
            <span class="label">
              <i class="bi bi-calendar-check"></i>
              {{ 'pricing.yearly' | translate }}
            </span>
            <span class="price">${{ plan.price_yearly }}</span>
            <span class="period">{{ 'pricing.perYear' | translate }}</span>
          </div>
        </div>
        <div class="savings-highlight" *ngIf="calculateSavings(plan) > 0">
          <i class="bi bi-piggy-bank-fill"></i>
          <span class="savings-text">
            {{ 'pricing.saveWith' | translate }} <strong>${{ calculateSavings(plan) }}</strong> 
            (<strong>{{ calculateSavingsPercentage(plan) }}%</strong>) {{ 'pricing.withYearly' | translate }}
          </span>
        </div>
        <div class="price-stats">
          <div class="stat-item">
            <span class="label">{{ 'pricing.monthlyTotal' | translate }}:</span>
            <span class="value">${{ plan.price_monthly * 12 }}</span>
          </div>
          <div class="stat-item">
            <span class="label">{{ 'pricing.yearlyPrice' | translate }}:</span>
            <span class="value">${{ plan.price_yearly }}</span>
          </div>
        </div>
      </div>

      <!-- Features -->
      <div class="features-list">
        <div class="features-header">
          <i class="bi bi-check-circle-fill"></i>
          <span>{{ 'pricing.features' | translate }} ({{ plan.features.length || 0 }})</span>
        </div>
        <div class="feature-item" *ngFor="let feature of plan.features; let i = index">
          <span class="feature-number">{{ i + 1 }}</span>
          <span class="feature-text">{{ feature }}</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="card-actions">
        <button class="btn-action edit" (click)="editPlan(plan)" [title]="'pricing.edit' | translate">
          <i class="bi bi-pencil-square"></i>
          <span>{{ 'common.edit' | translate }}</span>
        </button>
        <button class="btn-action duplicate" (click)="duplicatePlan(plan)" [title]="'pricing.duplicate' | translate">
          <i class="bi bi-files"></i>
          <span>{{ 'pricing.copy' | translate }}</span>
        </button>
        <button 
          class="btn-action toggle" 
          [class.active]="plan.is_active"
          (click)="toggleStatus(plan)" 
          [title]="plan.is_active ? ('pricing.deactivateAll' | translate) : ('pricing.activateAll' | translate)">
          <i class="bi" [class.bi-toggle-on]="plan.is_active" [class.bi-toggle-off]="!plan.is_active"></i>
          <span>{{ plan.is_active ? ('pricing.active' | translate) : ('pricing.inactive' | translate) }}</span>
        </button>
        <button class="btn-action delete" (click)="deletePlan(plan)" [title]="'pricing.delete' | translate">
          <i class="bi bi-trash3"></i>
          <span>{{ 'common.delete' | translate }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && filteredPlans.length === 0">
    <div class="empty-icon">
      <i class="bi bi-inbox"></i>
    </div>
    <h3>{{ 'pricing.noPricingFound' | translate }}</h3>
    <p *ngIf="searchTerm || selectedLanguage !== 'all' || selectedServiceType !== 'all' || selectedTier !== 'all'">
      {{ 'pricing.noMatch' | translate }}
    </p>
    <p *ngIf="!searchTerm && selectedLanguage === 'all' && selectedServiceType === 'all' && selectedTier === 'all'">
      {{ 'pricing.getStarted' | translate }}
    </p>
    <div class="empty-actions">
      <button class="btn btn-primary" (click)="openAddModal()">
        <i class="bi bi-plus-circle"></i>
        {{ 'pricing.createNew' | translate }}
      </button>
      <button class="btn btn-secondary" (click)="clearAllFilters()" *ngIf="searchTerm || selectedLanguage !== 'all' || selectedServiceType !== 'all' || selectedTier !== 'all'">
        <i class="bi bi-x-circle"></i>
        {{ 'pricing.clearAllFilters' | translate }}
      </button>
    </div>
  </div>

  <!-- Enhanced Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <i class="bi" [class.bi-plus-circle-fill]="!isEditMode" [class.bi-pencil-square]="isEditMode"></i>
          <h2>{{ isEditMode ? ('pricing.editPlan' | translate) : ('pricing.createNew' | translate) }}</h2>
        </div>
        <button class="close-btn" (click)="closeModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <form [formGroup]="planForm" (ngSubmit)="savePlan()">
        <div class="modal-body">
          <!-- Step Indicator -->
          <div class="form-steps">
            <div class="step active">
              <span class="step-number">1</span>
              <span class="step-label">{{ 'pricing.step1' | translate }}</span>
            </div>
            <div class="step-line"></div>
            <div class="step active">
              <span class="step-number">2</span>
              <span class="step-label">{{ 'pricing.step2' | translate }}</span>
            </div>
            <div class="step-line"></div>
            <div class="step active">
              <span class="step-number">3</span>
              <span class="step-label">{{ 'pricing.step3' | translate }}</span>
            </div>
          </div>

          <!-- Quick Template Toggle -->
          <div class="template-toggle-section" *ngIf="!isEditMode">
            <div class="toggle-card" [class.active]="useTemplate">
              <div class="toggle-header">
                <div class="toggle-icon">
                  <i class="bi bi-magic"></i>
                </div>
                <div class="toggle-content">
                  <h4>{{ 'pricing.useTemplate' | translate }}</h4>
                  <p>{{ 'pricing.templateDesc' | translate }}</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" [(ngModel)]="useTemplate" [ngModelOptions]="{standalone: true}" (change)="toggleTemplateMode()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="template-benefits" *ngIf="useTemplate">
                <div class="benefit-item">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>{{ 'pricing.templateBenefit1' | translate }}</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>{{ 'pricing.templateBenefit2' | translate }}</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>{{ 'pricing.templateBenefit3' | translate }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Language & Service Type -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="bi bi-info-circle"></i>
              {{ 'pricing.basicInfo' | translate }}
            </h3>
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'pricing.languageSelect' | translate }} <span class="required">*</span></label>
                <select formControlName="language" class="form-control" (change)="onLanguageChange()">
                  <option value="en">üá¨üáß {{ 'common.english' | translate }}</option>
                  <option value="ar">üá∏üá¶ {{ 'common.arabic' | translate }}</option>
                </select>
              </div>

              <div class="form-group">
                <label>{{ 'pricing.serviceTypeSelect' | translate }} <span class="required">*</span></label>
                <select formControlName="service_type" class="form-control" (change)="onServiceTypeChange()">
                  <option value="website">üåê {{ 'pricing.websiteDev' | translate }}</option>
                  <option value="app">üì± {{ 'pricing.appDev' | translate }}</option>
                  <option value="both">üöÄ {{ 'pricing.bothPackage' | translate }}</option>
                </select>
              </div>
            </div>

            <!-- Tier & Name -->
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'pricing.tierSelect' | translate }} <span class="required">*</span></label>
                <select formControlName="tier" class="form-control" (change)="onTierChange()">
                  <option value="basic">‚≠ê {{ 'pricing.basic' | translate }}</option>
                  <option value="professional">‚≠ê‚≠ê {{ 'pricing.professional' | translate }}</option>
                  <option value="enterprise">‚≠ê‚≠ê‚≠ê {{ 'pricing.enterprise' | translate }}</option>
                </select>
              </div>

              <div class="form-group">
                <label>{{ 'pricing.planName' | translate }} <span class="required">*</span></label>
                <input 
                  type="text" 
                  formControlName="name" 
                  class="form-control"
                  [placeholder]="'pricing.namePlaceholder' | translate">
              </div>
            </div>

            <!-- Description -->
            <div class="form-group">
              <label>{{ 'pricing.planDescription' | translate }} <span class="required">*</span></label>
              <textarea 
                formControlName="description" 
                class="form-control"
                rows="3"
                [placeholder]="'pricing.describeSpecial' | translate"></textarea>
              <small class="form-hint">
                <i class="bi bi-lightbulb"></i>
                {{ 'pricing.keepConcise' | translate }}
              </small>
            </div>
          </div>

          <!-- Pricing Section -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="bi bi-currency-dollar"></i>
              {{ 'pricing.pricingDetails' | translate }}
            </h3>
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'pricing.monthlyPrice' | translate }} <span class="required">*</span></label>
                <div class="input-with-icon">
                  <i class="bi bi-currency-dollar"></i>
                  <input 
                    type="number" 
                    formControlName="price_monthly" 
                    class="form-control"
                    min="0"
                    step="0.01"
                    placeholder="299.00">
                </div>
              </div>

              <div class="form-group">
                <label>{{ 'pricing.yearlyPrice' | translate }} <span class="required">*</span></label>
                <div class="input-with-icon">
                  <i class="bi bi-currency-dollar"></i>
                  <input 
                    type="number" 
                    formControlName="price_yearly" 
                    class="form-control"
                    min="0"
                    step="0.01"
                    placeholder="2990.00">
                </div>
              </div>
            </div>

            <!-- Savings Calculator -->
            <div class="savings-calculator" *ngIf="planForm.get('price_monthly')?.value > 0 && planForm.get('price_yearly')?.value > 0">
              <div class="calculator-header">
                <i class="bi bi-calculator"></i>
                <span>{{ 'pricing.savingsCalculator' | translate }}</span>
              </div>
              <div class="calculator-content">
                <div class="calc-row">
                  <span>{{ 'pricing.monthlyTotal' | translate }}:</span>
                  <strong>${{ (planForm.get('price_monthly')?.value * 12) | number:'1.2-2' }}</strong>
                </div>
                <div class="calc-row">
                  <span>{{ 'pricing.yearlyPrice' | translate }}:</span>
                  <strong>${{ planForm.get('price_yearly')?.value | number:'1.2-2' }}</strong>
                </div>
                <div class="calc-row highlight">
                  <span>{{ 'pricing.customerSaves' | translate }}:</span>
                  <strong class="savings-amount">
                    ${{ ((planForm.get('price_monthly')?.value * 12) - planForm.get('price_yearly')?.value) | number:'1.2-2' }}
                    ({{ ((((planForm.get('price_monthly')?.value * 12) - planForm.get('price_yearly')?.value) / (planForm.get('price_monthly')?.value * 12)) * 100) | number:'1.0-0' }}%)
                  </strong>
                </div>
              </div>
            </div>
          </div>

          <!-- Features Section -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="bi bi-list-check"></i>
              {{ 'pricing.planFeatures' | translate }}
            </h3>
            <div formArrayName="features" class="features-array">
              <div *ngFor="let feature of features.controls; let i = index" class="feature-input-group">
                <span class="feature-number">{{ i + 1 }}</span>
                <input 
                  type="text" 
                  [formControlName]="i" 
                  class="form-control"
                  [placeholder]="('pricing.feature' | translate) + ' ' + (i + 1)">
                <button 
                  type="button" 
                  class="btn-remove" 
                  (click)="removeFeature(i)"
                  [disabled]="features.length <= 1">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" (click)="addFeature()">
              <i class="bi bi-plus-circle"></i>
              {{ 'pricing.addAnotherFeature' | translate }}
            </button>
          </div>

          <!-- Options Section -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="bi bi-gear"></i>
              {{ 'pricing.additionalOptions' | translate }}
            </h3>
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'pricing.displayOrder' | translate }}</label>
                <input 
                  type="number" 
                  formControlName="order" 
                  class="form-control"
                  min="0"
                  placeholder="0">
                <small class="form-hint">
                  <i class="bi bi-info-circle"></i>
                  {{ 'pricing.orderHelp' | translate }}
                </small>
              </div>

              <div class="form-group">
                <label>{{ 'pricing.planSettings' | translate }}</label>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" formControlName="is_popular">
                    <span>
                      <i class="bi bi-star-fill"></i>
                      {{ 'pricing.markPopularChoice' | translate }}
                    </span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" formControlName="is_active">
                    <span>
                      <i class="bi bi-check-circle-fill"></i>
                      {{ 'pricing.visibleToCustomers' | translate }}
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="saving">
            <i class="bi bi-x-circle"></i>
            {{ 'common.cancel' | translate }}
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="saving || planForm.invalid">
            <span *ngIf="!saving">
              <i class="bi bi-check-circle"></i>
              {{ isEditMode ? ('pricing.updatePlan' | translate) : ('pricing.createPlan' | translate) }}
            </span>
            <span *ngIf="saving">
              <span class="spinner-small"></span>
              {{ 'pricing.savingPlan' | translate }}
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
